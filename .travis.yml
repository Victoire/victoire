sudo: false

services:
  - redis-server

language: php

git:
  depth: 5

cache:
  directories:
    - $HOME/.composer/cache

php:
#  - 5.6
  - 7.0
#  - hhvm

env:
  - SYMFONY_VERSION="2.8.*"
#  - SYMFONY_VERSION="3.1.*"

#matrix:
#  include:
#    - php: 5.6
#      env: SYMFONY_VERSION="2.7.*"
#    - php: 7.0
#      env: SYMFONY_VERSION="3.0.*"
#    - php: 7.0
#      env: SYMFONY_VERSION="3.2.*"

before_install:
  - cp -v Tests/Functionnal/app/config/parameters.yml.dist Tests/Functionnal/app/config/parameters.yml
  - npm install less
  - if [[ $TRAVIS_PHP_VERSION != '7.0' && $TRAVIS_PHP_VERSION != 'hhvm' && $PHPUNIT_FLAGS = "" ]]; then phpenv config-rm xdebug.ini; fi
  - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - php -r "if (hash_file('SHA384', 'composer-setup.php') === '55d6ead61b29c7bdee5cccfb50076874187bd9f21f65d8991d46ec5cc90518f447387fb9f76ebae1fbbacf329e583e30') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
  - php composer-setup.php
  - php -r "unlink('composer-setup.php');"


install:
  - php composer.phar require --dev symfony/symfony:${SYMFONY_VERSION} $DEPENDENCY --no-update
  - php composer.phar config "minimum-stability" "dev"
  - cat composer.json
  - php -d memory_limit=1536M composer.phar install --no-interaction -vv --profile --no-progress
  - php Tests/Functionnal/bin/console --env=ci doctrine:database:create --no-debug
  - php Tests/Functionnal/bin/console --env=ci doctrine:schema:create --no-debug
  - php Tests/Functionnal/bin/console --env=ci cache:warmup --no-debug
  - php Tests/Functionnal/bin/console --env=domain cache:warmup --no-debug
  - php Tests/Functionnal/bin/console --env=ci victoire:generate:view --no-debug
  - php Tests/Functionnal/bin/console --env=ci assets:install Tests/Functionnal/web --no-debug
  - php Tests/Functionnal/bin/console --env=ci bazinga:js-translation:dump --no-debug
  - php Tests/Functionnal/bin/console --env=ci fos:js:dump --target="Tests/Functionnal/web/js/fos_js_routes_test.js" --no-debug
  - php Tests/Functionnal/bin/console --env=domain fos:js:dump --target="Tests/Functionnal/web/js/fos_js_routes_domain.js" --no-debug
  - php Tests/Functionnal/bin/console --env=ci assetic:dump --no-debug
  - wget http://selenium-release.storage.googleapis.com/2.53/selenium-server-standalone-2.53.0.jar
  - java -jar selenium-server-standalone-2.53.0.jar > /dev/null 2>&1 &
  - php Tests/Functionnal/bin/console --env=ci server:run -r Tests/Functionnal/app/config/router_ci.php --no-debug > server.log 2>&1 &
  - Xvfb :99 -ac 2>/dev/null &
  - sleep 3 # give xvfb some time to start

script: php ./vendor/bin/behat --format=pretty --out=std

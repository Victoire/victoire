machine:
  timezone:
    Europe/Paris
  hosts:
    fr.victoire.io: 127.0.0.1
    en.victoire.io: 127.0.0.1
  services:
    - redis
  php:
    version: 7.0.4

dependencies:
  pre:
    - echo "memory_limit = 1024M" > ~/.phpenv/versions/5.6.5/etc/conf.d/memory.ini
    - echo "always_populate_raw_post_data=-1" > ~/.phpenv/versions/5.6.5/etc/conf.d/post_data.ini
  override:
    - npm install less
    - mkdir fails
    - composer install --prefer-dist
    - php Tests/Functionnal/bin/console --env=ci doctrine:database:create --no-debug
    - php Tests/Functionnal/bin/console --env=ci doctrine:schema:create --no-debug
    - php Tests/Functionnal/bin/console --env=ci cache:warmup --no-debug
    - php Tests/Functionnal/bin/console --env=ci victoire:generate:view --no-debug
    - php Tests/Functionnal/bin/console --env=ci assets:install Tests/Functionnal/web --no-debug
    - php Tests/Functionnal/bin/console --env=ci bazinga:js-translation:dump --no-debug
    - php Tests/Functionnal/bin/console --env=ci fos:js:dump --target="Tests/Functionnal/web/js/fos_js_routes_test.js" --no-debug
    - php Tests/Functionnal/bin/console --env=domain fos:js:dump --target="Tests/Functionnal/web/js/fos_js_routes_domain.js" --no-debug
    - php Tests/Functionnal/bin/console --env=ci assetic:dump --no-debug
    - wget http://selenium-release.storage.googleapis.com/2.53/selenium-server-standalone-2.53.0.jar
    - 'java -jar selenium-server-standalone-2.53.0.jar > /dev/null 2>&1':
          background: true
    - 'php Tests/Functionnal/bin/console --env=ci server:run -r Tests/Functionnal/app/config/router_ci.php --no-debug > server.log 2>&1':
          background: true
    - "Xvfb :99 -ac 2>/dev/null":
          background: true
    - sleep 3 # give xvfb some time to start
  cache_directories:
    - ~/.composer/cache

test:
  override:
    - bash circle-behat.sh Tests/Features:
        parallel: true
    - 'phpunit --coverage-text'
    - wget http://psvcg.coreteks.org/php-semver-checker-git.phar
    - >
      php php-semver-checker-git.phar suggest --allow-detached -vvv --details --include-before=src --include-after=src | awk '/Suggested semantic version: / {print $4}' | awk '{ print "{\"Suggested semantic version\":\"" $1 "\"}" }' > $CIRCLE_TEST_REPORTS/semver.json

general:
  artifacts:
    - "fails"
